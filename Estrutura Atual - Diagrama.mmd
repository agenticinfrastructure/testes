%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4F46E5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4338CA', 'lineColor': '#6366F1', 'secondaryColor': '#10B981', 'tertiaryColor': '#F59E0B', 'background': '#F8FAFC'}}}%%

flowchart TB
    %% ============================================================
    %% DIAGRAMA MVP â€” AGENTE ÃšNICO PRODUCTION-GRADE
    %% VersÃ£o: 1.0 | Data: 30/12/2025
    %% Foco: IntegraÃ§Ã£o ponta-a-ponta, Sandbox seguro, Observabilidade
    %% ============================================================

    subgraph USER_PLANE["ğŸ‘¤ USER PLANE"]
        USER["ğŸ“± User<br/><small>Browser / Mobile</small>"]
    end

    subgraph EDGE["ğŸŒ EDGE / CDN"]
        CLOUDFLARE["â˜ï¸ Cloudflare<br/><small>WAF + Cache + DDoS Protection</small><br/><small>âœ… Configurado</small>"]
    end

    subgraph CLIENTS["ğŸ“± CLIENTS (apps/)"]
        WEB["ğŸŒ Web App<br/><small>Next.js 14 + React 18</small><br/><small>âœ… Deployed (2 pods)</small>"]
        MOBILE["ğŸ“± Mobile App<br/><small>Expo + React Native</small><br/><small>â³ MVP+1</small>"]
    end

    subgraph BACKEND_SERVICES["âš™ï¸ BACKEND SERVICES (packages/services/)"]
        subgraph API_LAYER["ğŸ”Œ API Layer"]
            API["ğŸ”Œ Backend API<br/><small>Fastify 4 + REST</small><br/><small>ğŸ”§ Corrigir: K8s Secrets</small>"]
            
            subgraph API_ROUTES["ğŸ“¡ API Routes"]
                AUTH_ROUTES["ğŸ” /auth/*<br/><small>signup, login, refresh</small><br/><small>âœ… Implementado</small>"]
                BILLING_ROUTES["ğŸ’³ /billing/*<br/><small>checkout, portal</small><br/><small>âœ… Implementado</small>"]
                TASK_ROUTES["ğŸ¤– /v1/tasks/*<br/><small>create, status, cancel</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
                WEBHOOK_ROUTES["ğŸ”” /webhooks/*<br/><small>Stripe callbacks</small><br/><small>âœ… Implementado</small>"]
            end
        end

        subgraph LLM_SELECTOR["ğŸ¯ LLM Selector (packages/services/orchestrator/)"]
            MODEL_SELECTOR["ğŸ“Š Model Selector<br/><small>Seleciona LLM por critÃ©rios</small><br/><small>âœ… Implementado</small>"]
            CRITERIA_ENGINE["âš–ï¸ Criteria Engine<br/><small>68 critÃ©rios / 9 famÃ­lias</small><br/><small>âš ï¸ TODO no cÃ³digo</small>"]
        end
    end

    subgraph AGENT_RUNTIME["ğŸ§  AGENT RUNTIME (packages/core/agent-core/)"]
        subgraph TASK_LIFECYCLE["ğŸ“‹ Task Lifecycle"]
            TASK_QUEUE["ğŸ“¥ Task Queue<br/><small>Redis / In-Memory</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
            TASK_STATE["ğŸ“Š Task State<br/><small>pending â†’ running â†’ done/failed</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
        end

        AGENT["ğŸ¤– Agent (Singleton)<br/><small>agent.ts - Loop Principal</small><br/><small>âœ… Implementado</small>"]

        subgraph AGENT_MODULES["ğŸ§© Agent Modules"]
            PLANNER["ğŸ“‹ TodoManager<br/><small>Planejamento DinÃ¢mico</small><br/><small>âœ… Implementado</small>"]
            EXECUTOR["âš¡ ToolExecutor<br/><small>Executa ferramentas</small><br/><small>âœ… Implementado</small>"]
            MEMORY["ğŸ§  MemoryManager<br/><small>CompressÃ£o de Contexto</small><br/><small>âœ… Implementado</small>"]
            VERIFIER["âœ… VerificationManager<br/><small>ValidaÃ§Ã£o de Output</small><br/><small>âœ… Implementado</small>"]
            WORKSPACE["ğŸ“ WorkspaceManager<br/><small>FSaC - File System</small><br/><small>âœ… Implementado</small>"]
        end

        subgraph TOOLS_LAYER["ğŸ”§ Tools Layer"]
            subgraph SECURE_TOOLS["ğŸ”’ Secure Execution"]
                SANDBOX["ğŸ“¦ E2B Sandbox<br/><small>ExecuÃ§Ã£o Isolada</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
                SHELL_TOOL["ğŸ–¥ï¸ ShellTool<br/><small>â†’ Via Sandbox</small><br/><small>ğŸ”§ REFATORAR</small>"]
            end
            FILE_READ["ğŸ“– FileReadTool<br/><small>âœ… Implementado</small>"]
            FILE_WRITE["âœï¸ FileWriteTool<br/><small>âœ… Implementado</small>"]
            SEARCH_TOOL["ğŸ” SearchTool<br/><small>âœ… Implementado</small>"]
        end
    end

    subgraph LLM_PROVIDERS["â˜ï¸ LLM PROVIDERS"]
        subgraph ANTHROPIC["ğŸŸ£ Anthropic"]
            CLAUDE_SONNET["Claude 3.5 Sonnet<br/><small>Primary Reasoning</small><br/><small>âœ… API Key OK</small>"]
            CLAUDE_HAIKU["Claude 3.5 Haiku<br/><small>Fast Tasks</small><br/><small>âœ… API Key OK</small>"]
        end
        subgraph ALIBABA["ğŸŸ¢ Alibaba Cloud"]
            QWEN_TURBO["Qwen-Turbo<br/><small>Cost-Effective</small><br/><small>â³ VerificaÃ§Ã£o pendente</small>"]
            QWEN_MAX["Qwen-Max<br/><small>High Quality</small><br/><small>â³ VerificaÃ§Ã£o pendente</small>"]
        end
    end

    subgraph IMAGE_GEN["ğŸ¨ IMAGE GENERATION"]
        NANOBANANA["ğŸŒ NanoBanana<br/><small>Gemini Wrapper</small><br/><small>ğŸ”§ CORRIGIR: Ã‰ imagem, nÃ£o texto</small>"]
        GEMINI["ğŸ”· Gemini 2.0 Flash<br/><small>Backend real</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
    end

    subgraph PAYMENTS["ğŸ’³ PAYMENTS"]
        STRIPE_API["ğŸ’³ Stripe API<br/><small>Checkout + Webhooks</small><br/><small>âœ… Configurado</small>"]
    end

    subgraph DATA_LAYER["ğŸ—„ï¸ DATA LAYER"]
        POSTGRES["ğŸ˜ Cloud SQL<br/><small>PostgreSQL 15</small><br/><small>âœ… Deployed</small>"]
        REDIS["ğŸ”´ Redis<br/><small>Cache + Task Queue</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
    end

    subgraph OBSERVABILITY["ğŸ“Š OBSERVABILITY"]
        PROMETHEUS["ğŸ“ˆ Prometheus<br/><small>Metrics Collection</small><br/><small>âœ… Deployed</small>"]
        GRAFANA["ğŸ“Š Grafana<br/><small>Dashboards</small><br/><small>âœ… Deployed</small>"]
        ALERTMANAGER["ğŸš¨ Alertmanager<br/><small>Alertas</small><br/><small>âœ… Deployed</small>"]
        LOGGING["ğŸ“ Structured Logging<br/><small>JSON + Correlation ID</small><br/><small>ğŸ”§ IMPLEMENTAR</small>"]
    end

    subgraph INFRA["ğŸ­ INFRASTRUCTURE (GCP)"]
        GKE["â˜¸ï¸ GKE Cluster<br/><small>ai-platform-gke-staging</small><br/><small>âœ… Deployed</small>"]
        K8S_SECRETS["ğŸ”‘ K8s Secrets<br/><small>stripe, llm, db</small><br/><small>ğŸ”§ CONFIGURAR</small>"]
        ARTIFACT_REG["ğŸ“¦ Artifact Registry<br/><small>Container Images</small><br/><small>âœ… Deployed</small>"]
    end

    subgraph CICD["ğŸ”„ CI/CD"]
        GITHUB_ACTIONS["ğŸ™ GitHub Actions<br/><small>Build + Test + Deploy</small><br/><small>âš ï¸ Deploy timeout</small>"]
    end

    %% ============================================================
    %% FLUXO PRINCIPAL (PONTA-A-PONTA)
    %% ============================================================

    USER --> CLOUDFLARE
    CLOUDFLARE --> WEB
    MOBILE -.-> CLOUDFLARE

    WEB --> API
    
    %% API Routes
    API --> AUTH_ROUTES
    API --> BILLING_ROUTES
    API --> TASK_ROUTES
    API --> WEBHOOK_ROUTES

    %% Task Flow (INTEGRAÃ‡ÃƒO CRÃTICA)
    TASK_ROUTES -->|"POST /v1/tasks"| TASK_QUEUE
    TASK_QUEUE --> TASK_STATE
    TASK_STATE -->|"Inicia execuÃ§Ã£o"| AGENT

    %% Agent internal flow
    AGENT --> PLANNER
    AGENT --> EXECUTOR
    AGENT --> MEMORY
    AGENT --> VERIFIER
    AGENT --> WORKSPACE

    %% Tools execution
    EXECUTOR --> SANDBOX
    SANDBOX --> SHELL_TOOL
    EXECUTOR --> FILE_READ
    EXECUTOR --> FILE_WRITE
    EXECUTOR --> SEARCH_TOOL

    %% LLM Selection
    AGENT -->|"Solicita LLM"| MODEL_SELECTOR
    MODEL_SELECTOR --> CRITERIA_ENGINE
    MODEL_SELECTOR --> CLAUDE_SONNET
    MODEL_SELECTOR --> CLAUDE_HAIKU
    MODEL_SELECTOR --> QWEN_TURBO
    MODEL_SELECTOR --> QWEN_MAX

    %% Image Generation (separado de texto)
    MODEL_SELECTOR -.->|"GeraÃ§Ã£o de Imagem"| NANOBANANA
    NANOBANANA --> GEMINI

    %% Billing
    BILLING_ROUTES --> STRIPE_API
    WEBHOOK_ROUTES --> STRIPE_API

    %% Data Layer
    API --> POSTGRES
    TASK_STATE --> REDIS
    AGENT --> WORKSPACE

    %% Observability
    API -.-> PROMETHEUS
    AGENT -.-> PROMETHEUS
    PROMETHEUS --> GRAFANA
    PROMETHEUS --> ALERTMANAGER
    API -.-> LOGGING
    AGENT -.-> LOGGING

    %% Infrastructure
    GKE --> API
    GKE --> AGENT
    GKE --> K8S_SECRETS
    K8S_SECRETS -.-> API
    K8S_SECRETS -.-> AGENT

    %% CI/CD
    GITHUB_ACTIONS --> ARTIFACT_REG
    ARTIFACT_REG --> GKE

    %% ============================================================
    %% STYLING
    %% ============================================================
    classDef implemented fill:#10B981,stroke:#059669,color:#fff
    classDef partial fill:#F59E0B,stroke:#D97706,color:#fff
    classDef pending fill:#EF4444,stroke:#DC2626,color:#fff
    classDef critical fill:#DC2626,stroke:#991B1B,color:#fff,stroke-width:3px

    class CLOUDFLARE,WEB,AUTH_ROUTES,BILLING_ROUTES,WEBHOOK_ROUTES,MODEL_SELECTOR,AGENT,PLANNER,EXECUTOR,MEMORY,VERIFIER,WORKSPACE,FILE_READ,FILE_WRITE,SEARCH_TOOL,CLAUDE_SONNET,CLAUDE_HAIKU,STRIPE_API,POSTGRES,PROMETHEUS,GRAFANA,ALERTMANAGER,GKE,ARTIFACT_REG implemented
    class API,CRITERIA_ENGINE,QWEN_TURBO,QWEN_MAX,GITHUB_ACTIONS partial
    class TASK_ROUTES,TASK_QUEUE,TASK_STATE,SANDBOX,SHELL_TOOL,NANOBANANA,GEMINI,REDIS,K8S_SECRETS,LOGGING pending
    class MOBILE notstarted
